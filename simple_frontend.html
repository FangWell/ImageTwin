<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ImageTwin - å›¾ç‰‡ç›¸ä¼¼åº¦æœç´¢å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, button, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
        }
        .upload-area:hover {
            background-color: #f8f9fa;
        }
        .upload-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 5px;
            margin: 10px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .progress-container {
            margin: 10px 0;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            display: none;
        }
        .progress-bar {
            height: 20px;
            background-color: #007bff;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        .results {
            margin-top: 30px;
        }
        .result-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .result-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .result-info {
            flex: 1;
        }
        .similarity {
            font-weight: bold;
            color: #007bff;
        }
        .path {
            font-family: monospace;
            word-break: break-all;
            margin: 5px 0;
        }
        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        .slider-group {
            flex: 1;
            min-width: 200px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #similarityRange {
            width: 100%;
        }
        .status {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ImageTwin - å›¾ç‰‡ç›¸ä¼¼åº¦æœç´¢å·¥å…·</h1>
        
        <div class="status" id="statusDiv">
            <strong>çŠ¶æ€:</strong> <span id="statusText">è¿æ¥ä¸­...</span>
        </div>

        <div class="form-group">
            <label for="directoryInput">æœç´¢ç›®å½•:</label>
            <input type="text" id="directoryInput" placeholder="ä¾‹å¦‚: C:\Pictures" value="">
            <button onclick="indexDirectory()" id="indexBtn">ç´¢å¼•ç›®å½•</button>
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <div class="form-group">
            <label>ä¸Šä¼ å›¾ç‰‡:</label>
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect()">
                <div id="uploadText">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æ–‡ä»¶</div>
                <div id="selectedFile" style="display: none;"></div>
            </div>
        </div>

        <div class="form-group">
            <label>æœç´¢å‚æ•°:</label>
            <div class="controls">
                <div class="slider-group">
                    <label>ç›¸ä¼¼åº¦é˜ˆå€¼: <span id="thresholdValue">0.80</span></label>
                    <input type="range" id="similarityRange" min="0.1" max="1.0" step="0.01" value="0.8" oninput="updateThreshold()">
                    <small style="color: #666;">1.0 = å®Œå…¨ç›¸åŒï¼Œ0.8 = éå¸¸ç›¸ä¼¼</small>
                </div>
            </div>
        </div>

        <button onclick="searchSimilar()" id="searchBtn">ğŸ” æœç´¢ç›¸ä¼¼å›¾ç‰‡</button>

        <div class="results" id="results" style="display: none;">
            <h3>æœç´¢ç»“æœ:</h3>
            <div id="resultsList"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        
        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();
                document.getElementById('statusText').textContent = 
                    `è¿è¡Œä¸­ - å·²ç´¢å¼• ${data.total_indexed_images} å¼ å›¾ç‰‡`;
                document.getElementById('statusDiv').style.backgroundColor = '#d4edda';
                
                // æ¢å¤ä¸Šæ¬¡çš„ç›®å½•è®¾ç½®
                if (data.last_directory && !document.getElementById('directoryInput').value) {
                    document.getElementById('directoryInput').value = data.last_directory;
                }
            } catch (error) {
                document.getElementById('statusText').textContent = 'åç«¯æœåŠ¡æœªè¿æ¥';
                document.getElementById('statusDiv').style.backgroundColor = '#f8d7da';
            }
        }

        // æ›´æ–°ç›¸ä¼¼åº¦é˜ˆå€¼æ˜¾ç¤º
        function updateThreshold() {
            const value = document.getElementById('similarityRange').value;
            document.getElementById('thresholdValue').textContent = parseFloat(value).toFixed(2);
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (file) {
                document.getElementById('uploadText').style.display = 'none';
                document.getElementById('selectedFile').style.display = 'block';
                
                // åˆ›å»ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('selectedFile').innerHTML = `
                        <div>å·²é€‰æ‹©: ${file.name}</div>
                        <img src="${e.target.result}" alt="é¢„è§ˆ" class="upload-preview">
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        // ç´¢å¼•ç›®å½•
        async function indexDirectory() {
            const directory = document.getElementById('directoryInput').value.trim();
            if (!directory) {
                alert('è¯·è¾“å…¥ç›®å½•è·¯å¾„');
                return;
            }

            const indexBtn = document.getElementById('indexBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            indexBtn.textContent = 'ç´¢å¼•ä¸­...';
            indexBtn.disabled = true;
            progressContainer.style.display = 'block';
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
            }, 500);

            try {
                const response = await fetch(`${API_BASE}/api/index`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        directories: [directory]
                    })
                });

                const data = await response.json();
                
                // å®Œæˆè¿›åº¦
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                
                setTimeout(() => {
                    if (response.ok) {
                        alert(data.message);
                        checkStatus(); // æ›´æ–°çŠ¶æ€
                    } else {
                        alert(`ç´¢å¼•å¤±è´¥: ${data.detail}`);
                    }
                    
                    // é‡ç½®æŒ‰é’®çŠ¶æ€
                    indexBtn.textContent = 'ç´¢å¼•ç›®å½•';
                    indexBtn.disabled = false;
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                }, 1000);
                
            } catch (error) {
                clearInterval(progressInterval);
                alert(`ç´¢å¼•å¤±è´¥: ${error.message}`);
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                indexBtn.textContent = 'ç´¢å¼•ç›®å½•';
                indexBtn.disabled = false;
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
            }
        }

        // æœç´¢ç›¸ä¼¼å›¾ç‰‡
        async function searchSimilar() {
            const fileInput = document.getElementById('fileInput');
            const directory = document.getElementById('directoryInput').value.trim();
            const file = fileInput.files[0];

            if (!file) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            if (!directory) {
                alert('è¯·è¾“å…¥æœç´¢ç›®å½•');
                return;
            }

            const searchBtn = document.getElementById('searchBtn');
            const originalText = searchBtn.textContent;
            searchBtn.innerHTML = '<span class="loading"></span>æœç´¢ä¸­...';
            searchBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('directory', directory);
                formData.append('similarity_threshold', document.getElementById('similarityRange').value);

                const response = await fetch(`${API_BASE}/api/search`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (response.ok) {
                    displayResults(data.results);
                } else {
                    alert(`æœç´¢å¤±è´¥: ${data.detail}`);
                }
            } catch (error) {
                alert(`æœç´¢å¤±è´¥: ${error.message}`);
            } finally {
                searchBtn.innerHTML = originalText;
                searchBtn.disabled = false;
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            const resultsList = document.getElementById('resultsList');

            if (results.length === 0) {
                resultsList.innerHTML = '<p>æœªæ‰¾åˆ°ç›¸ä¼¼å›¾ç‰‡</p>';
            } else {
                resultsList.innerHTML = results.map((result, index) => {
                    const encodedPath = encodeURIComponent(result.path);
                    const imageUrl = `${API_BASE}/api/image/${encodedPath}`;
                    
                    return `
                    <div class="result-item">
                        <img src="${imageUrl}" 
                             alt="é¢„è§ˆå›¾ç‰‡" 
                             class="result-preview"
                             style="cursor: pointer;"
                             onclick="showLargePreview('${imageUrl}', '${result.path.replace(/\\/g, '\\\\')}')"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="result-preview" style="width: 100px; height: 100px; background: #f0f0f0; border-radius: 5px; display: none; align-items: center; justify-content: center; color: #666; font-size: 12px; text-align: center; flex-shrink: 0;">
                            ğŸ–¼ï¸<br>åŠ è½½å¤±è´¥
                        </div>
                        <div class="result-info">
                            <div class="similarity">ç›¸ä¼¼åº¦: ${(result.similarity * 100).toFixed(1)}%</div>
                            <div class="path" style="font-family: monospace; word-break: break-all; margin: 5px 0; font-size: 12px;">${result.path}</div>
                            <div style="margin-top: 10px;">
                                <button onclick="copyPath('${result.path.replace(/\\/g, '\\\\')}')">ğŸ“‹ å¤åˆ¶è·¯å¾„</button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }

            resultsDiv.style.display = 'block';
        }

        // æ˜¾ç¤ºå¤§å›¾é¢„è§ˆ
        function showLargePreview(imageUrl, imagePath) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                border-radius: 5px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            `;
            
            const info = document.createElement('div');
            info.textContent = imagePath;
            info.style.cssText = `
                position: absolute;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                color: white;
                background: rgba(0,0,0,0.7);
                padding: 10px 20px;
                border-radius: 5px;
                font-family: monospace;
                font-size: 12px;
                max-width: 80%;
                text-align: center;
                word-break: break-all;
            `;
            
            modal.appendChild(img);
            modal.appendChild(info);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»å…³é—­
            modal.onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // å¤åˆ¶è·¯å¾„åˆ°å‰ªè´´æ¿
        function copyPath(path) {
            navigator.clipboard.writeText(path).then(() => {
                showToast('è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                // å¤‡ç”¨æ–¹æ³•
                const textArea = document.createElement('textarea');
                textArea.value = path;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }



        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #333;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                font-size: 14px;
                max-width: 400px;
                word-wrap: break-word;
            `;
            
            document.body.appendChild(toast);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        checkStatus();
        
        // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>